name: Deploy Workinkorea Development Server
on:
  push:
    branches: [dev]

env:
  BASE_URL: byeong98.xyz
  DOCKER_IMAGE_NAME: workinkorea-server
  PORT: 8000

jobs:
  development-build-and-deploy:
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE_NAME }} .
          docker save ${{ env.DOCKER_IMAGE_NAME }} | gzip > image.tar.gz

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      - name: Copy image to remote server
        run: |
          scp -P ${{ secrets.SSH_PORT }} image.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/

      - name: Deploy on remote server
        run: |
          ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash << 'ENDSSH'
          set -e
          
          IMAGE_NAME="${{ env.DOCKER_IMAGE_NAME }}"
          BASE_URL="${{ env.BASE_URL }}"
          PORT="${{ env.PORT }}"
          
          echo "Loading Docker image..."
          docker load < ~/image.tar.gz
          
          echo "Stopping existing container..."
          docker stop ${IMAGE_NAME} 2>/dev/null || true
          docker rm ${IMAGE_NAME} 2>/dev/null || true
          
          echo "Starting new container..."
          docker run -d \
              --name ${IMAGE_NAME} \
              --network core_network \
              --restart unless-stopped \
              --label "traefik.enable=true" \
              --label "traefik.http.routers.${IMAGE_NAME}.rule=Host(\`arw.${BASE_URL}\`)" \
              --label "traefik.http.routers.${IMAGE_NAME}.entrypoints=websecure" \
              --label "traefik.http.routers.${IMAGE_NAME}.tls.certresolver=le" \
              --label "traefik.http.services.${IMAGE_NAME}.loadbalancer.server.port=${PORT}" \
              -e COOKIE_DOMAIN="${{ secrets.COOKIE_DOMAIN }}" \
              -e CLIENT_URL="${{ secrets.CLIENT_URL }}" \
              -e ORIGINS_URLS="${{ secrets.ORIGINS_URLS }}" \
              -e DATABASE_SYNC_URL="${{ secrets.DATABASE_SYNC_URL }}" \
              -e DATABASE_ASYNC_URL="${{ secrets.DATABASE_ASYNC_URL }}" \
              -e REDIS_HOST="${{ secrets.REDIS_HOST }}" \
              -e REDIS_PORT="${{ secrets.REDIS_PORT }}" \
              -e REDIS_DB="${{ secrets.REDIS_DB }}" \
              -e GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              -e GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              -e GOOGLE_REDIRECT_URI="${{ secrets.GOOGLE_REDIRECT_URI }}" \
              -e GOOGLE_AUTHORIZATION_URL="${{ secrets.GOOGLE_AUTHORIZATION_URL }}" \
              -e GOOGLE_TOKEN_URL="${{ secrets.GOOGLE_TOKEN_URL }}" \
              -e GOOGLE_USER_INFO_URL="${{ secrets.GOOGLE_USER_INFO_URL }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e JWT_ALGORITHM="${{ secrets.JWT_ALGORITHM }}" \
              -e ACCESS_TOKEN_EXPIRE_MINUTES="${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}" \
              -e REFRESH_TOKEN_EXPIRE_MINUTES="${{ secrets.REFRESH_TOKEN_EXPIRE_MINUTES }}" \
              -e MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}" \
              -e MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}" \
              -e MAIL_FROM_NAME="${{ secrets.MAIL_FROM_NAME }}" \
              -e MAIL_FROM="${{ secrets.MAIL_FROM }}" \
              -e MAIL_PORT="${{ secrets.MAIL_PORT }}" \
              -e MAIL_SERVER="${{ secrets.MAIL_SERVER }}" \
              -e MINIO_ENDPOINT="${{ secrets.MINIO_ENDPOINT }}" \
              -e MINIO_ACCESS_KEY="${{ secrets.MINIO_ACCESS_KEY }}" \
              -e MINIO_SECRET_KEY="${{ secrets.MINIO_SECRET_KEY }}" \
              -e MINIO_BUCKET_NAME="${{ secrets.MINIO_BUCKET_NAME }}" \
              -e ADMIN_JWT_SECRET="${{ secrets.ADMIN_JWT_SECRET }}" \
              -e ADMIN_JWT_ALGORITHM="${{ secrets.ADMIN_JWT_ALGORITHM }}" \
              -e ADMIN_ACCESS_TOKEN_EXPIRE_MINUTES="${{ secrets.ADMIN_ACCESS_TOKEN_EXPIRE_MINUTES }}" \
              -e ADMIN_REFRESH_TOKEN_EXPIRE_MINUTES="${{ secrets.ADMIN_REFRESH_TOKEN_EXPIRE_MINUTES }}" \
              -e ADMIN_EMAILS="${{ secrets.ADMIN_EMAILS }}" \
              ${IMAGE_NAME}
          
          echo "Cleaning up old images..."
          docker image prune -f
          
          echo "Removing temporary files..."
          rm -f ~/image.tar.gz
          
          echo "Deployment completed successfully!"
          ENDSSH

      - name: Send Discord Deployment Notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL_DEV }}
          status: ${{ job.status }}
          title: "Workinkorea-Server / Development"
          description: |
            **Deployment ${{ job.status == 'success' && 'Successful' || 'Failed' }}**
            
            • **Branch**: `${{ github.ref_name }}`
            • **Commit**: `${{ github.sha }}`
            • **Message**: ${{ github.event.head_commit.message }}
            • **Environment**: Development
            • **URL**: https://arw.${{ env.BASE_URL }}